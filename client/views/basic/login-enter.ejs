<!DOCTYPE html>
<html lang="en">

<head>
  <title>登录</title>
  <% include ../layout/layout %>
    <link rel="stylesheet" href="<%=_src('/css/basic/basic.min.css')%>">
    <script src="<%=_src('/lib/validform/Validform_v5.3.2_min.js')%>"></script>
</head>

<body>
  <div class="container">
    <form class="form-container" action="<%=_src(postUrl)%>" method="post">
      <div class="input-field">
        <div class="weui-cell input-code">
          <div class="weui-cell__bd">
            <input type="tel" name="code" placeholder="请输入短信验证码" datatype="number" errormsg="请输入正确的验证码！">
          </div>
          <div class="weui-cell__hd">
            <button id="getcode" type="button" class="weui-vcode-btn" onclick="getCode('<%=tel%>')">获取验证码</button>
          </div>
        </div>
        <div class="space">该手机已经注册, 请直接登录</div>
      </div>
      <div>
        <button type="submit" class="weui-btn weui-btn_primary">登录</button>
      </div>
    </form>
  </div>
  <div id="modal" style="display: none">
    <div class="weui-mask"></div>
    <div class="weui-dialog">
      <div class="weui-dialog__hd"><strong class="weui-dialog__title">提示信息</strong></div>
      <div class="weui-dialog__bd" id="message">
      </div>
      <div class="weui-dialog__ft">
        <a id="close" href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary">确定</a>
      </div>
    </div>
  </div>
  <% if (errorMessage) {%>
    <div id="modalerr">
      <div class="weui-mask"></div>
      <div class="weui-dialog">
        <div class="weui-dialog__hd"><strong class="weui-dialog__title">错误提示</strong></div>
        <div class="weui-dialog__bd">
          <%=errorMessage%>
        </div>
        <div class="weui-dialog__ft">
          <a id="closeerr" href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary">确定</a>
        </div>
      </div>
    </div>
  <%}%>
  <script>
  $(".form-container").Validform({
    tiptype: 3,
    postonce: true,
    datatype: {
      "number": /^\d{6}$/
    }
  });
  
  var count = 60;
  var t;
  function getCode(tel) {
    timedCount();
    $.get(window.location.pathname + "/getVerifyCode?tel=" + tel, function(result) {
      if(result.code === 0){
        $('#message').text(result.data);
        $('#modal').css('display', 'block');
      } else {
        var errormsg = JSON.parse(result) && JSON.parse(result).msg || '获取验证码失败';
        $('#message').text(errormsg);
        $('#modal').css('display', 'block');
      }
    });
  }

  function timedCount() {
    $('#getcode').attr('disabled', 'true');
    $('#getcode').text(count + '秒后重新获取');
    count--;
    t = setTimeout("timedCount()", 1000);
    if(count < 0) {
      count = 60;
      $('#getcode').text('获取验证码');
      $('#getcode').removeAttr('disabled');
      clearTimeout(t);
    }
  }

  $('#close').on('click', function() {
    $('#modal').css('display', 'none');
  });

  $('#closeerr').on('click', function() {
    $('#modalerr').css('display', 'none');
  });
  </script>
</body>

</html>

<!DOCTYPE html>
<html lang="en">

<head>
    <title>全程心管家</title>
    <% include ../layout/layout %>
    <link rel="stylesheet" href="<%= _src('/css/basic/basic.min.css') %>">
    <script src="<%= _src('/lib/validform/Validform_v5.3.2_min.js') %>"></script>
</head>

<body>
<div class="dc-check-in">
    <div class="dc-top">
        <div class="dc-middle">
            <span class="dc-number dc-num1">1</span><span class="dc-top-title">向医生报到</span>
            <img class="dc-top-img" src="<%= _src('/image/arrows.png') %>">
            <span class="dc-number dc-num2">2</span><span class="dc-top-title">注册登录</span>
        </div>
    </div>
    <div class="doc-intro">
        <div class="doc-into">
            <div class="doc-img">
                <img class="doc-pic" src="<%= doctorPic %>"></div>
            <div class="doc-content">
                <p class="doc-name"><%= doctorName %></p>
                <p class="doc-title"><%= department %> <%= doctorTitle %></p>
                <p class="doc-hospital"><%= hospitalName %></p>
            </div>
        </div>
        <div class="doc-tipe">
            <p>患者你好！我是<%= doctorName %>医生，若您曾在我这就诊过，请完整填写个人信息。如有出院小结等资料，请一并拍照上传！</p>
        </div>
    </div>
    <div class="patient">
        <div class="weui-cell">
            <div class="weui-cell__hd"><label class="weui-label" style="color: #333;">真实姓名</label></div>
            <div class="weui-cell__bd">
                <input class="weui-input" type="text" pattern="" maxlength="10" style="color: #999;" id="userName"
                       placeholder="请填写"/>
            </div>
        </div>
        <div class="weui-cell" style="border-top: 1px solid #ececec;">
            <div class="weui-cell__hd"><label for="" class="weui-label" style="color: #333;">就诊日期</label></div>
            <div class="weui-cell__bd">
                <input class="weui-input" type="date" value="" placeholder="请选择" id="userDate" style="color: #999;"/>
            </div>
        </div>
    </div>
    <div class="patient-introduce">
        <div class="weui-cells__title" style="font-size: 14px;color: #666;">申请描述</div>
        <div class="weui-cells weui-cells_form"
             style="border-radius: 4px;border-left: 1px solid #ececec;border-right: 1px solid #ececec;">
            <div class="weui-cell">
                <div class="weui-cell__bd">
                    <textarea class="weui-textarea" style="font-size: 14px;color: #999;" id="userIntroduce"
                              placeholder="请简单描述自己的就诊情况。例如：我是XXX，从2017年10月20日住进瑞金医院1508号床，10月25日进行了PCI手术。"
                              rows="3" maxlength="100"></textarea>
                    <div class="weui-textarea-counter"><span>0</span>/100</div>
                </div>
            </div>
        </div>
        <div class="weui-cell" id="uploader">
            <div class="weui-cell__bd">
                <div class="weui-uploader">
                    <div class="weui-uploader__hd">
                        <p class="weui-uploader__title" style="font-size: 14px;color: #ccc;">添加病历出院小结等照片</p>
                        <div class="weui-uploader__info"><span id="uploadCount">0</span>/9</div>
                    </div>
                    <div class="weui-uploader__bd">
                        <ul class="weui-uploader__files" id="uploaderFiles"></ul>
                        <div class="weui-uploader__input-box">
                            <input id="uploaderInput" class="weui-uploader__input" type="file" accept="image/*"
                                   multiple/>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="weui-cell weui-cell_switch patient-btn">
        <div class="weui-cell__bd">允许医生查看我的全部病例</div>
        <div class="weui-cell__ft">
            <label for="switchCP" class="weui-switch-cp">
                <input id="switchCP" class="weui-switch-cp__input" type="checkbox" checked="checked"/>
                <div class="weui-switch-cp__box"></div>
            </label>
        </div>
    </div>
    <button class="weui-btn weui-btn_primary check-btn " id="uploaderCustomBtn">立即申请</button>
</div>
</body>
</html>
<style>
    .weui-cell:before {
        border-top: none;
    }

    .dc-top {
        font-size: 14px;
        color: #35B2F2;
        height: 30px;
        margin: 10px 0 5px 0;
        text-align: center;
    }

    .dc-middle {
        width: 70%;
        height: 100%;
        margin: 0 auto;
    }

    .dc-number {
        height: 20px;
        width: 20px;
        background-color: white;
        border-radius: 20px;
        border: 2px solid #35B2F2;
        text-align: center;
        float: left;
    }

    .dc-num2 {
        margin-left: 4%;
    }

    .dc-top-title {
        float: left;
        margin-left: 2%;
    }

    .dc-top-img {
        width: 13%;
        float: left;
        margin-left: 4%;
        height: 12px;
        margin-top: 5px;
    }

    .doc-intro {
        background-color: white;
        height: 175px;
        padding: 10px 15px;
    }

    .doc-into {
        height: 95px;
        border-bottom: 1px dotted #dfdfdf;
    }

    .doc-img {
        float: left;
        width: 25%
    }

    .doc-pic {
        width: 70px;
        height: 70px;
        border-radius: 35px;
    }

    .doc-content {
        float: left;
        width: 70%;
    }

    .doc-name {
        font-size: 17px;
        color: #333;
    }

    .doc-title {
        font-size: 14px;
        color: #999
    }

    .doc-hospital {
        font-size: 14px;
        color: #999
    }

    .doc-tipe {
        height: 87px;
        padding: 10px 0;
        font-size: 14px;
        color: #999;
    }

    .patient {
        height: 90px;
        margin-top: 10px;
        background-color: white;
        font-size: 16px;
    }

    .patient-introduce {
        background-color: white;
        margin-top: 10px;
        padding: 10px 15px;
    }

    .patient-btn {
        margin-top: 10px;
        background-color: white;
        color: #333;
    }

    .check-btn {
        margin: 20px 0;
        border-radius: 5px;
        background-color: #35B2F2;
    }

    .weui-uploader__bd {
        overflow: inherit;
    }
</style>
<script type="text/javascript">
    var url = "<%= url %>"
    var admissionTime = ""
    var doctorId = <%= doctorId %>
    var imgUrlList = []
    var uploadCustomFileList = []
    var message = ""
    var messageNum = 0
    var realName = ""
    var userId = sessionStorage.userId

    // 获取七牛token和domain
    var domain;
    var token;
    $.ajax({
        type: 'get',
        url: `http://10.2.10.10/pci-micro/api/qiniu/auth`,
        success: function (res) {
            if (res && res.code === 0) {
                domain = res.data.domain
                token = res.data.token
            }
        },
        error: function (error) {
            console.log(error)
        }
    })

    //真实姓名
    $('#userName').on("input", function () {
        if (this.value.length) {
            realName = this.value;
        }
    });

    //就诊日期
    $('#userDate').on("input", function () {
        if (this.value.length) {
            admissionTime = this.value;
            admissionTime = new Date(Date.parse(admissionTime.replace(/-/g, "/")));
            admissionTime = admissionTime.getTime();
        }
    });

    //申请描述
    $('#userIntroduce').on("input", function () {
        if (this.value.length) {
            messageNum = this.value.length
            message = this.value;
            $(".weui-textarea-counter span").text(messageNum)
        } else {
            message = "";
        }
    })

    //上传图片
    /* 图片手动上传 */
    // 这里是简单的调用，其余api请参考文档
    var uploadCount = 0;
    weui.uploader('#uploader', {
        url: 'http://upload.qiniup.com/',
        auto: false,
        type: 'file',
        fileVal: 'file',
        compress: {
            width: 1600,
            height: 1600,
            quality: .8
        },
        onBeforeQueued: function (files) {
            // `this` 是轮询到的文件, `files` 是所有文件

            if (["image/jpg", "image/jpeg", "image/png", "image/gif"].indexOf(this.type) < 0) {
                weui.alert('请上传图片');
                return false; // 阻止文件添加
            }
            if (this.size > 10 * 1024 * 1024) {
                weui.alert('请上传不超过10M的图片');
                return false;
            }
            if (files.length > 9) { // 防止一下子选择过多文件
                weui.alert('最多只能上传9张图片，请重新选择');
                return false;
            }
            if (uploadCount + 1 > 9) {
                $(".weui-uploader__input-box").hide();
                weui.alert('最多只能上传9张图片');
                return false;
            }
            if (uploadCount > 8 || files.length > 8) {
                $(".weui-uploader__input-box").hide();
            }

            ++uploadCount;
            $('#uploadCount').text(uploadCount);

            // return true; // 阻止默认行为，不插入预览图的框架
        },
        onQueued: function () {
            uploadCustomFileList.push(this);
            // console.log(this.status); // 文件的状态：'ready', 'progress', 'success', 'fail'
            // console.log(this.base64); // 如果是base64上传，file.base64可以获得文件的base64

            // this.upload(); // 如果是手动上传，这里可以通过调用upload来实现；也可以用它来实现重传。
            // this.stop(); // 中断上传

            // return true; // 阻止默认行为，不显示预览图的图像
        },
        onBeforeSend: function (data, headers) {
            $.extend(data, {token: token}); // 可以扩展此对象来控制上传参数
            // $.extend(headers, { Origin: 'http://127.0.0.1' }); // 可以扩展此对象来控制上传头部

            // return false; // 阻止文件上传
        },
        onProgress: function (procent) {
            // return true; // 阻止默认行为，不使用默认的进度显示
        },
        onSuccess: function (ret) {
            imgUrlList.push(`${domain}${ret.key}`)
            if (imgUrlList.length === uploadCount) {
                ajax()
            }
            // return true; // 阻止默认行为，不使用默认的成功态
        },
        onError: function (err) {
            console.log(err)
            // return true; // 阻止默认行为，不使用默认的失败态
        }
    });

    // 手动上传按钮
    document.getElementById("uploaderCustomBtn").addEventListener('click', function () {
        uploadCustomFileList.forEach(function (file) {
            file.upload();
        });

    });
    // 删除图片
    $("#uploaderFiles").on('click', '.delete', function (e) {
        var id = e.target.getAttribute('delete-id');
        weui.confirm('确定删除该图片？', function () {
            --uploadCount;
            $('#uploadCount').text(uploadCount);
            var index;
            for (var i = 0, len = uploadCustomFileList.length; i < len; ++i) {
                var file = uploadCustomFileList[i];
                if (file.id == id) {
                    index = i;
                    break;
                }
            }
            if (index !== undefined) uploadCustomFileList.splice(index, 1);

            e.target.parentNode.remove();

            if (uploadCount + 1 < 10) {
                $(".weui-uploader__input-box").show();
            }

        });
    });

    $(function(){
        $('.weui-switch-cp__box').on('click', function () {
            let isCheck = $("#switchCP").prop("checked");
            if (isCheck == false) {
                $("#uploaderCustomBtn").removeAttr("disabled");
                $(".weui-btn_primary").css('cssText','background-color:##35B2F2 !important; color:#fff !important');
                $('#uploaderCustomBtn').on('click', function () {
                    if (realName == "") {
                        weui.alert('请填写真实姓名');
                    }
                    if (admissionTime == "") {

                        weui.alert('请选择就诊日期');
                    }
                    if (userId == undefined) {
//                        window.location.href = ``
                    }
                });
            }else{
                 $("#uploaderCustomBtn").attr({"disabled":"disabled"});
                $(".weui-btn_primary").css('cssText','background-color:#ddd !important; color:#fff !important');
            }
        });
    });


    //立即申请
    function ajax() {
        var dto = {
            "admissionTime": admissionTime,
            "doctorId": doctorId,
            "imgUrlList": imgUrlList,
            "message": message,
            "realName": realName,
            "userId": userId
        };
        $.ajax({
        url: `${url}/api/doctorPatient/apply`,
        type: "POST",
            headers: {
                'access-token': '0ee4fbd3-088e-4d79-83a6-44569f071020',
                'version': '1.3'
            },
        data: JSON.stringify(dto),
        contentType: 'application/json',
        dataType: 'json',
        success: function(data) {
        if (data.code === 0) {
            console.log('success');
        } else {
        var msg;
        if (data.msg) {
        msg = data.msg;
        } else {
        msg = '提交失败！';
        }
        $('#message').text(msg);
        $('#modal').css('display', 'block');
        }
        },
        error: function() {
        $('#message').text('请求失败！');
        $('#modal').css('display', 'block');
        }
        });
    }
</script>